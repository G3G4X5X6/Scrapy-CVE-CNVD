# -*- coding: utf-8 -*-
import scrapy
from OnePiece.items import OnepieceItem
import datetime
import json
import logging

logger = logging.getLogger(__name__)
logging.basicConfig(level=logging.INFO,
                    format='%(levelname)s'
                    '   [%(filename)s:%(lineno)d]   msg:  %(message)s'
                    ' - %(asctime)s',
                    datefmt='[%d/%b/%Y %H:%M:%S]',
                    filename='./loggmsg.log')

class AllSpider(scrapy.Spider):
    name = 'all'
    allowed_domains = ['cnvd.org.cn', 'cassandra.cerias.purdue.edu', 'cve.mitre.org', 'cnnvd.org.cn']
    start_urls = ['https://www.cnvd.org.cn/flaw/typeResult', 'https://cassandra.cerias.purdue.edu/CVE_changes/today.html']

    def start_requests(self):
        logger.info("start spider")
        for url in self.start_urls:
            if 'cnvd.org' in url:
                #js渲染
                # yield SplashRequest(url, self.parse, args={'wait':0.5, 'images':0 ,'timeout': 50})
                yield scrapy.FormRequest(url, formdata={"typeId":"29"}, callback=self.cnvd_parse)
            else:
                yield scrapy.Request(url=url, callback=self.cve_parse,)

    def cnvd_parse(self, response):
        res = response.xpath("//table[@class='tlist']/tbody/tr")
        for link in res:
            url = "https://www.cnvd.org.cn" + link.xpath("./td/a/@href").extract_first()
            yield scrapy.Request(url=url, callback=self.get_detail)


    def cve_parse(self, response):
        res = response.xpath("//a")
        for ids in res:
            id = ids.xpath("./text()").extract_first()
            sec_cve_id = "CVE-" + id
            url = "http://www.cnnvd.org.cn/web/vulnerability/queryLds.tag?qcvCnnvdid={}".format(sec_cve_id)
            # print(sec_cve_id)
            yield scrapy.Request(url=url, callback=self.search, meta={'id':sec_cve_id})

    def search(self, response):
        sec_cve_id = response.meta['id']
        res = response.xpath("/html/body/div[4]/div/div[1]/div/div[2]/ul/li")
        for li in res:
            # id = li.xpath("./a/text()").extract()
            part = li.xpath(".//a/@href").extract_first()
            if len(part) > 4:
                url = "http://www.cnnvd.org.cn" + li.xpath(".//a/@href").extract_first()
                yield scrapy.Request(url=url, callback=self.get_deatil_by_cnnvd, meta={'id':sec_cve_id, 'url':url})
            else:
                url = "http://cve.mitre.org/cgi-bin/cvename.cgi?name={}".format(sec_cve_id[3:])
                print(url)


    def get_detail(self, response):
        sec_cnvd_id = response.xpath("//div[@class='mw Main clearfix']/div[@class='blkContainer']/div[@class='blkContainerPblk']/div[@class='blkContainerSblk']/div[@class='blkContainerSblkCon clearfix']/div[@class='tableDiv']/table[@class='gg_detail']/tbody/tr[1]/td[2]//text()").extract_first().strip()
        sec_name = response.xpath("//div[@class='mw Main clearfix']/div[@class='blkContainer']/div[@class='blkContainerPblk']/div[@class='blkContainerSblk']/h1/text()").extract_first().strip()
        sec_url = response.request.url
        sec_date = response.xpath("//div[@class='mw Main clearfix']/div[@class='blkContainer']/div[@class='blkContainerPblk']/div[@class='blkContainerSblk']/div[@class='blkContainerSblkCon clearfix']/div[@class='tableDiv']/table[@class='gg_detail']/tbody/tr[2]/td[2]/text()").extract_first().strip()
        sec_from = "cnvd"
        if("CVE-" in str(response.xpath(".").extract())):
            sec_cve_id = response.xpath("/html/body/div[@class='mw Main clearfix']/div[@class='blkContainer']/div[@class='blkContainerPblk']/div[@class='blkContainerSblk']/div[@class='blkContainerSblkCon clearfix']/div[@class='tableDiv']/table[@class='gg_detail']/tbody/tr[5]/td[2]/a/text()").extract_first().strip()
            sec_type = response.xpath("/html/body/div[@class='mw Main clearfix']/div[@class='blkContainer']/div[@class='blkContainerPblk']/div[@class='blkContainerSblk']/div[@class='blkContainerSblkCon clearfix']/div[@class='tableDiv']/table[@class='gg_detail']/tbody/tr[7]/td[2]/text()").extract_first().strip()
            sec_desc = "".join(response.xpath("/html/body/div[@class='mw Main clearfix']/div[@class='blkContainer']/div[@class='blkContainerPblk']/div[@class='blkContainerSblk']/div[@class='blkContainerSblkCon clearfix']/div[@class='tableDiv']/table[@class='gg_detail']/tbody/tr[6]/td[2]/text()").extract()).strip().replace("\r", "").replace("\n", "").replace("\t", "").replace(" ", "")
        else:
            sec_cve_id = "None"
            sec_type = response.xpath(
                "/html/body/div[@class='mw Main clearfix']/div[@class='blkContainer']/div[@class='blkContainerPblk']/div[@class='blkContainerSblk']/div[@class='blkContainerSblkCon clearfix']/div[@class='tableDiv']/table[@class='gg_detail']/tbody/tr[6]/td[2]/text()").extract_first().strip()
            sec_desc = "".join(response.xpath(
                "/html/body/div[@class='mw Main clearfix']/div[@class='blkContainer']/div[@class='blkContainerPblk']/div[@class='blkContainerSblk']/div[@class='blkContainerSblkCon clearfix']/div[@class='tableDiv']/table[@class='gg_detail']/tbody/tr[5]/td[2]/text()").extract()).strip().replace("\r", "").replace("\n", "").replace("\t", "").replace(" ", "")
        sec_level = "".join(response.xpath("/html/body/div[4]/div[1]/div[1]/div[1]/div[2]/div[1]/table/tbody/tr[3]/td[2]/text()").extract()).strip().replace("\r", "").replace("\n", "").replace("\t", "").replace(" ", "").replace("(", "").replace(")", "")

        today = datetime.date.today()
        yesterday = today - datetime.timedelta(days=1)
        if str(sec_date) == str(today) or str(sec_date) == str(yesterday):
            item = OnepieceItem()
            item["sec_cnvd_id"] = sec_cnvd_id
            item["sec_cve_id"] = sec_cve_id
            item["sec_name"] = sec_name
            item["sec_url"] = sec_url
            item["sec_date"] = sec_date
            item["sec_type"] = sec_type
            item["sec_from"] = sec_from
            item["sec_level"] = sec_level
            item["sec_desc"] = sec_desc
            yield item
            # print("sec_cnvd_id = " + sec_cnvd_id)
            # print("sec_cve_id = " + sec_cve_id)
            # print("sec_name = " + sec_name)
            # print("sec_url = " + sec_url)
            # print("sec_date = "  + sec_date)
            # print("sec_type = " + sec_type)
            # print("sec_from = " + sec_from)
            # print("sec_level = " + sec_level)

    def get_deatil_by_cnnvd(self, response):
        sec_cve_id = response.meta['id']
        sec_cnvd_id = "None"
        sec_name = response.xpath(
            "/html/body/div[@class='container m_t_10']/div[@class='container m_t_20']/div[@class='fl w770']/div[@class='detail_xq w770']/h2/text()").extract_first().strip()
        sec_url = response.meta['url']
        sec_date = response.xpath(
            "/html/body/div[@class='container m_t_10']/div[@class='container m_t_20']/div[@class='fl w770']/div[@class='detail_xq w770']/ul/li[7]/a/text()").extract_first().strip()
        sec_type = response.xpath(
            "/html/body/div[@class='container m_t_10']/div[@class='container m_t_20']/div[@class='fl w770']/div[@class='detail_xq w770']/ul/li[4]/a/text()").extract_first().strip()
        sec_from = "cve"
        sec_level = response.xpath(
            "/html/body/div[@class='container m_t_10']/div[@class='container m_t_20']/div[@class='fl w770']/div[@class='detail_xq w770']/ul/li[2]/a/text()").extract_first().strip()
        if len(sec_level) == 0:
            sec_level = "未知"
        sec_desc = "".join(response.xpath(
            "/html/body/div[@class='container m_t_10']/div[@class='container m_t_20']/div[@class='fl w770']/div[@class='d_ldjj']/p/text()").extract()).strip().replace(
            "\r", "").replace("\n", "").replace("\t", "").replace(" ", "").replace("(", "").replace(")", "")
        # print("sec_cnvd_id = " + sec_cnvd_id)
        # print("sec_cve_id = " + sec_cve_id)
        # print("sec_name = " + sec_name)
        # print("sec_url = " + sec_url)
        # print("sec_date = "  + sec_date)
        # print("sec_type = " + sec_type)
        # print("sec_from = " + sec_from)
        # print("sec_level = " + sec_level)
        # print("sec_desc = " + str(sec_desc))
        today = datetime.date.today()
        yesterday = today - datetime.timedelta(days=1)
        if str(sec_date) == str(today) or str(sec_date) == str(yesterday):
            item = OnepieceItem()
            item["sec_cnvd_id"] = sec_cnvd_id
            item["sec_cve_id"] = sec_cve_id
            item["sec_name"] = sec_name
            item["sec_url"] = sec_url
            item["sec_date"] = sec_date
            item["sec_type"] = sec_type
            item["sec_from"] = sec_from
            item["sec_level"] = sec_level
            item["sec_desc"] = sec_desc
            yield item
