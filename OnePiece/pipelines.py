# -*- coding: utf-8 -*-

# Define your item pipelines here
#
# Don't forget to add your pipeline to the ITEM_PIPELINES setting
# See: https://docs.scrapy.org/en/latest/topics/item-pipeline.html
import json
import datetime
import smtplib
from email.mime.text import MIMEText
from email.mime.image import MIMEImage
from email.mime.multipart import MIMEMultipart
from email.mime.application import MIMEApplication

class OnepiecePipeline(object):

    def __init__(self):
        today = datetime.datetime.now().strftime('%Y-%m-%d')
        self.file_name = "{}.txt".format(str(today))
        self.data = open(self.file_name, 'a+', encoding='utf-8')

    def process_item(self, item, spider):
        dict_item = dict(item)
        self.data.write("cvd_id: " + dict_item["sec_cve_id"] + "\n")
        self.data.write("cnvd_id: " + dict_item["sec_cnvd_id"] + "\n")
        self.data.write("level: " + dict_item["sec_level"] + "\n")
        self.data.write("type: " + dict_item["sec_type"] + "\n")
        self.data.write("url: " + dict_item["sec_url"] + "\n")
        self.data.write("date: " + dict_item["sec_date"] + "\n")
        self.data.write("name: " + dict_item["sec_name"] + "\n")
        self.data.write("desc: " + dict_item["sec_desc"] + "\n")
        self.data.write("==========================================================" "\n")
        return item
    def close_spider(self, spider):

        fromaddr = 'xxxx@163.com'
        password = 'xxxxxxxxxxxxxx'
        toaddrs = 'xxxx@163.com'
        content = 'today-cve-cnvd'

        textApart = MIMEText(content)
        resFile = self.file_name
        resApart = MIMEApplication(open(resFile, 'rb').read())
        resApart.add_header('Content-Disposition', 'attachment', filename=resFile)

        m = MIMEMultipart()
        m.attach(textApart)
        m.attach(resApart)
        m['Subject'] = 'title'

        try:
            server = smtplib.SMTP_SSL('smtp.163.com', 465)
            server.login(fromaddr, password)
            server.sendmail(fromaddr, toaddrs, m.as_string())
            print('success')
            server.quit()
        except smtplib.SMTPException as e:
            print('error:', e)

